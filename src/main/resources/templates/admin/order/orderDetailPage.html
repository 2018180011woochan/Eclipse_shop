<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{common/layout}">
<head>
    <meta charset="UTF-8">
    <title>주문 상세 페이지</title>
    <link rel="stylesheet" href="/common/css/bootstrap.min.css">
</head>
<body>
<main layout:fragment="content">
    <div class="container mt-5">
        <h1>주문 상세 정보</h1>

        <!-- 주문 정보 -->
        <div class="card mb-4">
            <div class="card-header">
                주문 정보
            </div>
            <div class="card-body">
                <div class="form-group">
                    <label for="orderStatus"><strong>주문 상태:</strong></label>
                    <select id="orderStatus" name="orderStatus" class="form-control">
                        <option th:each="status : ${T(com.example.shop_project_v2.order.OrderStatus).values()}"
                                th:value="${status}"
                                th:text="${status}"
                                th:selected="${status == order.orderStatus}">
                        </option>
                    </select>
                </div>
                <button id="updateStatusBtn" class="btn btn-primary">상태 업데이트</button>
                <p id="statusMessage" class="mt-2 text-success"></p>
                <p><strong>결제 방법:</strong> <span th:text="${order.paymentMethod}"></span></p>
                <p><strong>총 금액:</strong> <span th:text="${order.totalPrice} + '원'"></span></p>
            </div>
        </div>

        <!-- 주문자 정보 -->
        <div class="card mb-4">
            <div class="card-header">
                주문자 정보
            </div>
            <div class="card-body">
                <p><strong>이메일:</strong> <span th:text="${order.member.email}"></span></p>
                <p><strong>이름:</strong> <span th:text="${order.member.name}"></span></p>
                <p><strong>전화번호:</strong> <span th:text="${order.member.phone}"></span></p>
                <p><strong>주소:</strong> <span th:text="${order.member.address}"></span></p>
                <p><strong>상세 주소:</strong> <span th:text="${order.member.addressDetail}"></span></p>
            </div>
        </div>

        <!-- 주문 아이템 정보 -->
        <div class="card mb-4">
            <div class="card-header">
                주문 아이템 정보
            </div>
            <div class="card-body">
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>상품명</th>
                            <th>옵션</th>
                            <th>수량</th>
                            <th>가격</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="orderItem : ${order.orderItems}">
                            <td th:text="${orderItem.productName}"></td>
                            <td>
                                <span th:text="${orderItem.color}"></span> /
                                <span th:text="${orderItem.size}"></span>
                            </td>
                            <td th:text="${orderItem.quantity}"></td>
                            <td th:text="${orderItem.totalPrice} + '원'"></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- 사용한 포인트 정보 -->
        <div class="card mb-4" th:if="${order.usedPoint != null}">
            <div class="card-header">
                사용한 포인트
            </div>
            <div class="card-body">
                <p><strong>사용 포인트:</strong> <span th:text="${order.usedPoint.usedPoint} + '점'"></span></p>
                <p><strong>사용 이유:</strong> <span th:text="${order.usedPoint.usedReason}"></span></p>
                <p><strong>사용 일자:</strong> <span th:text="${order.usedPoint.createdDate}"></span></p>
            </div>
        </div>

        <!-- 뒤로 가기 버튼 -->
        <a th:href="@{/admin/orders}" class="btn btn-secondary">뒤로 가기</a>
    </div>
    

    <script>
    document.addEventListener("DOMContentLoaded", function() {
        const orderIdField = document.getElementById("orderId");
        const orderStatusField = document.getElementById("orderStatus");
        const statusMessage = document.getElementById("statusMessage");
        const updateBtn = document.getElementById("updateStatusBtn");

        updateBtn.addEventListener("click", function() {
            const orderId = orderIdField.value;         // hidden input에서 값 읽어옴
            const newStatus = orderStatusField.value;   // select에서 값 읽어옴

            fetch('/admin/api/orders/' + orderId + '/update-status', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: new URLSearchParams({ orderStatus: newStatus })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('서버 응답 실패: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                // 성공
                statusMessage.textContent = data.message; // "주문 상태가 업데이트되었습니다."
                orderStatusField.value = data.newStatus;   // NEW -> SHIPPED 등
            })
            .catch(error => {
                // 실패
                statusMessage.textContent = '상태 업데이트에 실패했습니다.';
                console.error(error);
            });
        });
    });
    </script>
</main>
</body>
</html>